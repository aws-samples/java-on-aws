Metadata:
  cdk_nag:
    rules_to_suppress:
      - id: AwsSolutions-APIG1
        reason: API Gateway access logging not needed for workshop
      - id: AwsSolutions-APIG2
        reason: API Gateway request validation not needed for workshop
      - id: AwsSolutions-APIG3
        reason: Workshop API Gateways do not need AWS WAF
      - id: AwsSolutions-APIG4
        reason: Workshop environment does not require API Gateway authorization
      - id: AwsSolutions-APIG6
        reason: API Gateway access logging not needed for workshop
      - id: AwsSolutions-COG4
        reason: Workshop environment does not require Cognito User Pool authorization
      - id: AwsSolutions-IAM4
        reason: AWS Managed policies are acceptable for workshop
      - id: AwsSolutions-IAM5
        reason: Wildcard permissions acceptable for workshop parallel resource creation
      - id: AwsSolutions-RDS2
        reason: Workshop non-sensitive test database does not need encryption at rest
      - id: AwsSolutions-RDS3
        reason: Workshop environment does not need Multi-AZ to reduce cost
      - id: AwsSolutions-RDS6
        reason: Workshop environment uses user/password authentication
      - id: AwsSolutions-RDS10
        reason: Workshop environment is ephemeral - database deleted at end
      - id: AwsSolutions-RDS11
        reason: Database in private subnet can use default port
      - id: AwsSolutions-RDS13
        reason: Workshop database does not need backups
      - id: AwsSolutions-VPC7
        reason: Workshop environment does not need VPC flow logs
      - id: AwsSolutions-EC23
        reason: Workshop security groups allow broad access for learning
      - id: AwsSolutions-SMG4
        reason: Ephemeral workshop environment does not need secret rotation
      - id: AwsSolutions-CFR1
        reason: Workshop environment should be accessible from any geo
      - id: AwsSolutions-CFR2
        reason: Ephemeral workshop environment does not need WAF
      - id: AwsSolutions-CFR3
        reason: Ephemeral workshop environment does not need logging
      - id: AwsSolutions-CFR4
        reason: Workshop IDE uses HTTP origin
      - id: AwsSolutions-CFR5
        reason: Workshop IDE uses HTTP origin
      - id: AwsSolutions-EKS1
        reason: Workshop EKS cluster uses public access for learning
      - id: AwsSolutions-EKS2
        reason: Workshop EKS cluster does not need control plane logging
      - id: AwsSolutions-EC28
        reason: Workshop instance does not need detailed monitoring
      - id: AwsSolutions-EC29
        reason: Workshop instance does not need termination protection
      - id: AwsSolutions-CB4
        reason: CodeBuild uses default AWS-managed CMK for S3
      - id: AwsSolutions-S1
        reason: Workshop S3 bucket does not need access logs
      - id: AwsSolutions-L1
        reason: Workshop environment uses CDK default Lambda runtimes
      - id: AwsSolutions-ELB2
        reason: Workshop environment does not need ALB logs
      - id: AwsSolutions-ECS2
        reason: Workshop environment uses temporary containers
      - id: AwsSolutions-ECS4
        reason: Workshop environment does not need Container Insights
      - id: CdkNagValidationFailure
        reason: Suppress CDK Nag validation warnings
Outputs:
  IdePassword:
    Description: Workshop IDE Password
    Export:
      Name: ide-password
    Value:
      Fn::GetAtt:
        - IdePasswordResource07883F17
        - password
  IdeUrl:
    Description: Workshop IDE Url
    Export:
      Name: ide-url
    Value:
      Fn::Join:
        - ""
        - - https://
          - Fn::GetAtt:
              - IdeDistribution042A6660
              - DomainName
          - /?folder=/home/ec2-user/environment&tkn=
          - Fn::GetAtt:
              - IdePasswordResource07883F17
              - password
Parameters:
  SsmParameterValueawsserviceamiamazonlinuxlatestal2023amikernel61x8664C96584B6F00A464EAD1953AFF4B05118Parameter:
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
Resources:
  AiJvmAnalyzerServiceRole295D6B19:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
              - sts:TagSession
            Effect: Allow
            Principal:
              Service: pods.eks.amazonaws.com
        Version: "2012-10-17"
      Description: Role for ai-jvm-analyzer EKS pod to access Bedrock and S3
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonBedrockLimitedAccess
      RoleName: ai-jvm-analyzer-eks-pod-role
    Type: AWS::IAM::Role
  AiJvmAnalyzerServiceRoleDefaultPolicyE0960C92:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject
              - s3:ListBucket
              - s3:PutObject
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - WorkshopBucketFD5BC43F
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - WorkshopBucketFD5BC43F
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: AiJvmAnalyzerServiceRoleDefaultPolicyE0960C92
      Roles:
        - Ref: AiJvmAnalyzerServiceRole295D6B19
    Type: AWS::IAM::Policy
  BedrockLoggingRole71F633EF:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Condition:
              ArnLike:
                aws:SourceArn:
                  Fn::Join:
                    - ""
                    - - "arn:aws:bedrock:"
                      - Ref: AWS::Region
                      - ":"
                      - Ref: AWS::AccountId
                      - :*
              StringEquals:
                aws:SourceAccount:
                  Ref: AWS::AccountId
            Effect: Allow
            Principal:
              Service: bedrock.amazonaws.com
        Version: "2012-10-17"
      Description: Role for Bedrock model invocation logging to CloudWatch
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Effect: Allow
                Resource:
                  Fn::Join:
                    - ""
                    - - "arn:aws:logs:"
                      - Ref: AWS::Region
                      - ":"
                      - Ref: AWS::AccountId
                      - :log-group:/aws/bedrock/*
            Version: "2012-10-17"
          PolicyName: BedrockLogging
      RoleName: workshop-bedrock-logging-role
    Type: AWS::IAM::Role
  CfnPreDeleteCleanupFA953B95:
    DeletionPolicy: Delete
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - CfnPreDeleteCleanupFunction580FB700
          - Arn
      VpcId:
        Ref: VpcC3027511
    Type: AWS::CloudFormation::CustomResource
    UpdateReplacePolicy: Delete
  CfnPreDeleteCleanupFunction580FB700:
    DependsOn:
      - CfnPreDeleteCleanupRoleDefaultPolicy7B910EB7
      - CfnPreDeleteCleanupRole2BF62B3D
    Properties:
      Code:
        ZipFile: |
          import boto3
          import time
          import cfnresponse

          ec2 = boto3.client('ec2')
          s3 = boto3.client('s3')
          s3_resource = boto3.resource('s3')

          def lambda_handler(event, context):
              """
              Custom Resource handler to cleanup resources before stack deletion.
              - GuardDuty VPC endpoints that block VPC deletion
              - GuardDuty managed security groups
              - S3 bucket contents for workshop- buckets
              Note: CloudWatch logs are kept for debugging/analysis
              """
              print(f"Event: {event}")

              request_type = event['RequestType']
              vpc_id = event['ResourceProperties'].get('VpcId', '')

              try:
                  if request_type == 'Delete':
                      # Start VPC endpoint deletion (async)
                      endpoint_ids = start_guardduty_endpoint_deletion(vpc_id)

                      # While endpoints are deleting, clean up S3
                      cleanup_s3_buckets()

                      # Wait for VPC endpoint deletion to complete
                      if endpoint_ids:
                          wait_for_deletion(endpoint_ids, max_wait=300)

                      # Delete GuardDuty security groups (after endpoints are deleted)
                      cleanup_guardduty_security_groups(vpc_id)

                  cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
              except Exception as e:
                  print(f"Error: {e}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {'Error': str(e)})

          def start_guardduty_endpoint_deletion(vpc_id):
              """Find and start deletion of GuardDuty VPC endpoints."""

              # Find GuardDuty data endpoints
              filters = [{'Name': 'service-name', 'Values': ['*guardduty-data*']}]
              if vpc_id:
                  filters.append({'Name': 'vpc-id', 'Values': [vpc_id]})

              response = ec2.describe_vpc_endpoints(Filters=filters)
              endpoints = response.get('VpcEndpoints', [])

              if not endpoints:
                  print("No GuardDuty endpoints found")
                  return []

              endpoint_ids = [ep['VpcEndpointId'] for ep in endpoints]
              print(f"Found GuardDuty endpoints: {endpoint_ids}")

              # Start deletion (don't wait yet)
              for endpoint_id in endpoint_ids:
                  print(f"Deleting endpoint: {endpoint_id}")
                  try:
                      ec2.delete_vpc_endpoints(VpcEndpointIds=[endpoint_id])
                  except Exception as e:
                      print(f"Error deleting {endpoint_id}: {e}")

              return endpoint_ids

          def cleanup_guardduty_security_groups(vpc_id, max_retries=6, retry_delay=10):
              """Delete GuardDuty managed security groups for the VPC with retry logic."""
              if not vpc_id:
                  print("No VPC ID provided, skipping security group cleanup")
                  return

              try:
                  # Find GuardDuty managed security groups by name pattern
                  response = ec2.describe_security_groups(
                      Filters=[
                          {'Name': 'vpc-id', 'Values': [vpc_id]},
                          {'Name': 'group-name', 'Values': [f'GuardDutyManagedSecurityGroup-{vpc_id}']}
                      ]
                  )

                  security_groups = response.get('SecurityGroups', [])

                  if not security_groups:
                      print("No GuardDuty security groups found")
                      return

                  for sg in security_groups:
                      sg_id = sg['GroupId']
                      sg_name = sg['GroupName']
                      print(f"Deleting GuardDuty security group: {sg_name} ({sg_id})")

                      # Retry deletion - ENIs may take time to detach after endpoint deletion
                      for attempt in range(max_retries):
                          try:
                              ec2.delete_security_group(GroupId=sg_id)
                              print(f"Deleted security group: {sg_id}")
                              break
                          except ec2.exceptions.ClientError as e:
                              if 'DependencyViolation' in str(e) and attempt < max_retries - 1:
                                  print(f"Security group has dependencies, waiting {retry_delay}s (attempt {attempt + 1}/{max_retries})...")
                                  time.sleep(retry_delay)
                              else:
                                  print(f"Error deleting security group {sg_id}: {e}")
                                  break

              except Exception as e:
                  print(f"Error listing GuardDuty security groups: {e}")

              print("GuardDuty security group cleanup completed")

          def cleanup_s3_buckets():
              """Empty S3 buckets with workshop- prefix."""
              try:
                  response = s3.list_buckets()
                  for bucket in response.get('Buckets', []):
                      bucket_name = bucket['Name']
                      if bucket_name.startswith('workshop-'):
                          print(f"Emptying S3 bucket: {bucket_name}")
                          empty_bucket(bucket_name)
              except Exception as e:
                  print(f"Error listing S3 buckets: {e}")

              print("S3 bucket cleanup completed")

          def empty_bucket(bucket_name):
              """Delete all objects and versions from a bucket using boto3 resource API."""
              try:
                  bucket = s3_resource.Bucket(bucket_name)
                  # Delete all object versions (handles both versioned and non-versioned buckets)
                  bucket.object_versions.delete()
                  print(f"Emptied bucket: {bucket_name}")
              except Exception as e:
                  print(f"Error emptying bucket {bucket_name}: {e}")

          def wait_for_deletion(endpoint_ids, max_wait=300):
              """Poll until endpoints are fully deleted (not just deleting) or timeout."""
              start_time = time.time()

              while time.time() - start_time < max_wait:
                  try:
                      response = ec2.describe_vpc_endpoints(VpcEndpointIds=endpoint_ids)
                      endpoints = response.get('VpcEndpoints', [])

                      # Wait for fully deleted state, not just deleting
                      remaining = [ep for ep in endpoints if ep['State'] != 'deleted']

                      if not remaining:
                          print("All endpoints fully deleted")
                          return

                      states = {ep['VpcEndpointId']: ep['State'] for ep in remaining}
                      print(f"Waiting for endpoints: {states}")
                      time.sleep(10)
                  except ec2.exceptions.ClientError as e:
                      if 'InvalidVpcEndpointId.NotFound' in str(e):
                          print("All endpoints deleted (not found)")
                          return
                      raise

              print(f"Timeout waiting for endpoint deletion after {max_wait}s")
      Description: Cleanup VPC endpoints, CloudWatch logs, and S3 buckets before stack deletion
      FunctionName: workshop-cfn-pre-delete-cleanup
      Handler: index.lambda_handler
      Role:
        Fn::GetAtt:
          - CfnPreDeleteCleanupRole2BF62B3D
          - Arn
      Runtime: python3.13
      Timeout: 600
    Type: AWS::Lambda::Function
  CfnPreDeleteCleanupRole2BF62B3D:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Type: AWS::IAM::Role
  CfnPreDeleteCleanupRoleDefaultPolicy7B910EB7:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - ec2:DeleteSecurityGroup
              - ec2:DeleteVpcEndpoints
              - ec2:DescribeSecurityGroups
              - ec2:DescribeVpcEndpoints
              - s3:DeleteObject
              - s3:DeleteObjectVersion
              - s3:ListAllMyBuckets
              - s3:ListBucket
              - s3:ListBucketVersions
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: CfnPreDeleteCleanupRoleDefaultPolicy7B910EB7
      Roles:
        - Ref: CfnPreDeleteCleanupRole2BF62B3D
    Type: AWS::IAM::Policy
  CodeBuild2FDE9E35:
    DeletionPolicy: Delete
    DependsOn:
      - CodeBuildCompleteRuleAllowEventRuleWorkshopStackCodeBuildReportLambdaFunctionD77C60919E0B0C89
      - CodeBuildCompleteRuleEE9277E8
      - CodeBuildReportLambdaFunctionA3C396F7
    Properties:
      CodeBuildIamRoleArn:
        Fn::GetAtt:
          - CodeBuildRoleE9A44575
          - Arn
      ContentHash: "1768809143448"
      ProjectName:
        Ref: CodeBuildProjectA0FF5539
      ServiceToken:
        Fn::GetAtt:
          - CodeBuildStartLambdaFunction8349284F
          - Arn
    Type: AWS::CloudFormation::CustomResource
    UpdateReplacePolicy: Delete
  CodeBuildCompleteRuleAllowEventRuleWorkshopStackCodeBuildReportLambdaFunctionD77C60919E0B0C89:
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - CodeBuildReportLambdaFunctionA3C396F7
          - Arn
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
          - CodeBuildCompleteRuleEE9277E8
          - Arn
    Type: AWS::Lambda::Permission
  CodeBuildCompleteRuleEE9277E8:
    Properties:
      Description: workshop-setup build complete
      EventPattern:
        detail:
          build-status:
            - SUCCEEDED
            - FAILED
            - STOPPED
          project-name:
            - Ref: CodeBuildProjectA0FF5539
        detail-type:
          - CodeBuild Build State Change
        source:
          - aws.codebuild
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - CodeBuildReportLambdaFunctionA3C396F7
              - Arn
          Id: Target0
    Type: AWS::Events::Rule
  CodeBuildLambdaRole655C06B4:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Type: AWS::IAM::Role
  CodeBuildLambdaRoleDefaultPolicyFB35F0AF:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: CodeBuildLambdaRoleDefaultPolicyFB35F0AF
      Roles:
        - Ref: CodeBuildLambdaRole655C06B4
    Type: AWS::IAM::Policy
  CodeBuildProjectA0FF5539:
    DependsOn:
      - CodeBuildProjectPolicyDocument567377F5
    Properties:
      Artifacts:
        Type: NO_ARTIFACTS
      Cache:
        Type: NO_CACHE
      EncryptionKey: alias/aws/s3
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        EnvironmentVariables:
          - Name: TEMPLATE_TYPE
            Type: PLAINTEXT
            Value: java-on-aws-immersion-day
          - Name: GIT_BRANCH
            Type: PLAINTEXT
            Value: main
        Image: aws/codebuild/amazonlinux2-x86_64-standard:5.0
        ImagePullCredentialsType: CODEBUILD
        PrivilegedMode: false
        Type: LINUX_CONTAINER
      Name: workshop-setup
      ServiceRole:
        Fn::GetAtt:
          - CodeBuildRoleE9A44575
          - Arn
      Source:
        BuildSpec: |
          version: 0.2
          env:
            shell: bash
          phases:
            install:
              commands:
                - |
                  aws --version
                  echo "Environment Variables:"
                  echo "TEMPLATE_TYPE: $TEMPLATE_TYPE"
                  echo "GIT_BRANCH: $GIT_BRANCH"
            build:
              commands:
                - |
                  # Resolution for when creating the first service in the account
                  aws iam create-service-linked-role --aws-service-name ecs.amazonaws.com 2>/dev/null || true
                  aws iam create-service-linked-role --aws-service-name elasticloadbalancing.amazonaws.com 2>/dev/null || true
        Type: NO_SOURCE
      TimeoutInMinutes: 30
      VpcConfig:
        SecurityGroupIds:
          - Fn::GetAtt:
              - CodeBuildProjectSecurityGroup7CE557B3
              - GroupId
        Subnets:
          - Ref: VpcPrivateSubnet1Subnet67A4DBCB
          - Ref: VpcPrivateSubnet2SubnetC8EB537D
        VpcId:
          Ref: VpcC3027511
    Type: AWS::CodeBuild::Project
  CodeBuildProjectPolicyDocument567377F5:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - ec2:CreateNetworkInterface
              - ec2:DeleteNetworkInterface
              - ec2:DescribeDhcpOptions
              - ec2:DescribeNetworkInterfaces
              - ec2:DescribeSecurityGroups
              - ec2:DescribeSubnets
              - ec2:DescribeVpcs
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: CodeBuildProjectPolicyDocument567377F5
      Roles:
        - Ref: CodeBuildRoleE9A44575
    Type: AWS::IAM::Policy
  CodeBuildProjectSecurityGroup7CE557B3:
    Properties:
      GroupDescription: Automatic generated security group for CodeBuild WorkshopStackCodeBuildProjectD1046FA9
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::SecurityGroup
  CodeBuildReportLambdaFunctionA3C396F7:
    DependsOn:
      - CodeBuildLambdaRoleDefaultPolicyFB35F0AF
      - CodeBuildLambdaRole655C06B4
    Properties:
      Code:
        ZipFile: |-
          import boto3
          import json

          codebuild = boto3.client('codebuild')

          def lambda_handler(event, context):
              print(f'Build status event: {event}')

              try:
                  # Extract build information from EventBridge event
                  detail = event['detail']
                  build_status = detail['build-status']
                  project_name = detail['project-name']
                  build_id = detail['build-id']

                  print(f'Build {build_id} for project {project_name} finished with status: {build_status}')

                  if build_status == 'SUCCEEDED':
                      print('✅ CodeBuild setup completed successfully')
                  elif build_status == 'FAILED':
                      print('❌ CodeBuild setup failed')

                      # Get build details for error information
                      response = codebuild.batch_get_builds(ids=[build_id])
                      if response['builds']:
                          build = response['builds'][0]
                          if 'logs' in build and 'cloudWatchLogs' in build['logs']:
                              log_group = build['logs']['cloudWatchLogs'].get('groupName')
                              log_stream = build['logs']['cloudWatchLogs'].get('streamName')
                              print(f'Check logs at: {log_group}/{log_stream}')
                  elif build_status == 'STOPPED':
                      print('⏹️ CodeBuild setup was stopped')

                  return {
                      'statusCode': 200,
                      'body': json.dumps({
                          'message': f'Processed build status: {build_status}',
                          'buildId': build_id,
                          'projectName': project_name
                      })
                  }

              except Exception as e:
                  print(f'Error processing build status: {str(e)}')
                  return {
                      'statusCode': 500,
                      'body': json.dumps({
                          'error': str(e)
                      })
                  }
      FunctionName: workshop-setup-report
      Handler: index.lambda_handler
      Role:
        Fn::GetAtt:
          - CodeBuildLambdaRole655C06B4
          - Arn
      Runtime: python3.13
      Timeout: 120
    Type: AWS::Lambda::Function
  CodeBuildRoleDefaultPolicy196BAF24:
    Properties:
      PolicyDocument:
        Statement:
          - Action: ec2:CreateNetworkInterfacePermission
            Condition:
              StringEquals:
                ec2:AuthorizedService: codebuild.amazonaws.com
                ec2:Subnet:
                  - Fn::Join:
                      - ""
                      - - "arn:"
                        - Ref: AWS::Partition
                        - ":ec2:"
                        - Ref: AWS::Region
                        - ":"
                        - Ref: AWS::AccountId
                        - :subnet/
                        - Ref: VpcPrivateSubnet1Subnet67A4DBCB
                  - Fn::Join:
                      - ""
                      - - "arn:"
                        - Ref: AWS::Partition
                        - ":ec2:"
                        - Ref: AWS::Region
                        - ":"
                        - Ref: AWS::AccountId
                        - :subnet/
                        - Ref: VpcPrivateSubnet2SubnetC8EB537D
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":ec2:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :network-interface/*
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeBuildProjectA0FF5539
                    - :*
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CodeBuildProjectA0FF5539
          - Action:
              - codebuild:BatchPutCodeCoverages
              - codebuild:BatchPutTestCases
              - codebuild:CreateReport
              - codebuild:CreateReportGroup
              - codebuild:UpdateReport
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":codebuild:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :report-group/
                  - Ref: CodeBuildProjectA0FF5539
                  - -*
        Version: "2012-10-17"
      PolicyName: CodeBuildRoleDefaultPolicy196BAF24
      Roles:
        - Ref: CodeBuildRoleE9A44575
    Type: AWS::IAM::Policy
  CodeBuildRoleE9A44575:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/PowerUserAccess
    Type: AWS::IAM::Role
  CodeBuildStartLambdaFunction8349284F:
    DependsOn:
      - CodeBuildLambdaRoleDefaultPolicyFB35F0AF
      - CodeBuildLambdaRole655C06B4
    Properties:
      Code:
        ZipFile: |-
          import boto3
          import json
          import traceback
          import cfnresponse

          codebuild = boto3.client('codebuild')

          def lambda_handler(event, context):
              print(f'Event: {event}')
              responseData = {}
              status = cfnresponse.SUCCESS
              physical_id = event.get('PhysicalResourceId', 'CodeBuildSetup')

              try:
                  if event['RequestType'] == 'Delete':
                      # Nothing to clean up for CodeBuild
                      responseData = {'Message': 'CodeBuild setup deleted'}
                      cfnresponse.send(event, context, status, responseData, physical_id)
                      return

                  if event['RequestType'] == 'Update':
                      # For updates, trigger a new build
                      pass

                  # Start CodeBuild project
                  props = event['ResourceProperties']
                  project_name = props['ProjectName']

                  print(f'Starting CodeBuild project: {project_name}')

                  response = codebuild.start_build(
                      projectName=project_name
                  )

                  build_id = response['build']['id']
                  build_arn = response['build']['arn']

                  print(f'Started build: {build_id}')

                  responseData = {
                      'BuildId': build_id,
                      'BuildArn': build_arn,
                      'ProjectName': project_name
                  }

                  # Use build ID as physical resource ID for tracking
                  physical_id = build_id

              except Exception as e:
                  status = cfnresponse.FAILED
                  tb_err = traceback.format_exc()
                  print(tb_err)
                  responseData = {'Error': tb_err}

              cfnresponse.send(event, context, status, responseData, physical_id)
      FunctionName: workshop-setup-start
      Handler: index.lambda_handler
      Role:
        Fn::GetAtt:
          - CodeBuildLambdaRole655C06B4
          - Arn
      Runtime: python3.13
      Timeout: 120
    Type: AWS::Lambda::Function
  DatabaseCluster5B53A178:
    DeletionPolicy: Delete
    Properties:
      CopyTagsToSnapshot: true
      DBClusterIdentifier: workshop-db-cluster
      DBClusterParameterGroupName: default.aurora-postgresql16
      DBSubnetGroupName:
        Ref: DatabaseClusterSubnets5540150D
      DatabaseName: workshop
      EnableHttpEndpoint: true
      Engine: aurora-postgresql
      EngineVersion: "16.4"
      MasterUserPassword:
        Fn::Join:
          - ""
          - - "{{resolve:secretsmanager:"
            - Ref: DatabaseSecret3B817195
            - :SecretString:password::}}
      MasterUsername:
        Fn::Join:
          - ""
          - - "{{resolve:secretsmanager:"
            - Ref: DatabaseSecret3B817195
            - :SecretString:username::}}
      Port: 5432
      ServerlessV2ScalingConfiguration:
        MaxCapacity: 4
        MinCapacity: 0.5
      VpcSecurityGroupIds:
        - Fn::GetAtt:
            - DatabaseSG562817C8
            - GroupId
    Type: AWS::RDS::DBCluster
    UpdateReplacePolicy: Delete
  DatabaseClusterDatabaseWriterF4C0B9A6:
    DeletionPolicy: Delete
    DependsOn:
      - VpcPrivateSubnet1DefaultRouteF704DE9F
      - VpcPrivateSubnet1RouteTableAssociation2BC202CB
      - VpcPrivateSubnet2DefaultRoute5FAC9901
      - VpcPrivateSubnet2RouteTableAssociationFA51927B
    Properties:
      AutoMinorVersionUpgrade: true
      DBClusterIdentifier:
        Ref: DatabaseCluster5B53A178
      DBInstanceClass: db.serverless
      DBInstanceIdentifier: workshop-db-writer
      Engine: aurora-postgresql
      PromotionTier: 0
      PubliclyAccessible: false
    Type: AWS::RDS::DBInstance
    UpdateReplacePolicy: Delete
  DatabaseClusterSubnets5540150D:
    Properties:
      DBSubnetGroupDescription: Subnets for Cluster database
      SubnetIds:
        - Ref: VpcPrivateSubnet1Subnet67A4DBCB
        - Ref: VpcPrivateSubnet2SubnetC8EB537D
    Type: AWS::RDS::DBSubnetGroup
  DatabaseConnectionString52D1E98E:
    Properties:
      AllowedPattern: .*
      Description: Database Connection String
      Name: workshop-db-connection-string
      Tier: Standard
      Type: String
      Value:
        Fn::Join:
          - ""
          - - jdbc:postgresql://
            - Fn::GetAtt:
                - DatabaseCluster5B53A178
                - Endpoint.Address
            - :5432/workshop
    Type: AWS::SSM::Parameter
  DatabaseSG562817C8:
    Properties:
      GroupDescription: WorkshopStack/Database/SG
      GroupName: workshop-db-sg
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      SecurityGroupIngress:
        - CidrIp: 10.0.0.0/16
          Description: Allow Database Traffic from local network
          FromPort: 5432
          IpProtocol: tcp
          ToPort: 5432
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::SecurityGroup
  DatabaseSecret3B817195:
    DeletionPolicy: Delete
    Properties:
      Description:
        Fn::Join:
          - ""
          - - "Generated by the CDK for stack: "
            - Ref: AWS::StackName
      GenerateSecretString:
        ExcludeCharacters: " %+~`#$&*()|[]{}:;<>?!'/@\"\\"
        GenerateStringKey: password
        PasswordLength: 30
        SecretStringTemplate: '{"username":"postgres"}'
      Name: workshop-db-secret
    Type: AWS::SecretsManager::Secret
    UpdateReplacePolicy: Delete
  DatabaseSecretAttachmentE5D1B020:
    Properties:
      SecretId:
        Ref: DatabaseSecret3B817195
      TargetId:
        Ref: DatabaseCluster5B53A178
      TargetType: AWS::RDS::DBCluster
    Type: AWS::SecretsManager::SecretTargetAttachment
  EcrRegistryTemplateD54113AB:
    Properties:
      AppliedFor:
        - CREATE_ON_PUSH
        - REPLICATION
      CustomRoleArn:
        Fn::GetAtt:
          - EcrRegistryTemplateRole9295BC5C
          - Arn
      Description: Auto-create repositories on push with lifecycle policies for workshop workshop
      ImageTagMutability: MUTABLE
      LifecyclePolicy: |
        {
            "rules": [
                {
                    "rulePriority": 1,
                    "description": "Expire untagged images after 1 day",
                    "selection": {
                        "tagStatus": "untagged",
                        "countType": "sinceImagePushed",
                        "countUnit": "days",
                        "countNumber": 1
                    },
                    "action": {
                        "type": "expire"
                    }
                },
                {
                    "rulePriority": 2,
                    "description": "Keep only 10 most recent tagged images",
                    "selection": {
                        "tagStatus": "tagged",
                        "tagPrefixList": ["latest", "v"],
                        "countType": "imageCountMoreThan",
                        "countNumber": 10
                    },
                    "action": {
                        "type": "expire"
                    }
                }
            ]
        }
      Prefix: ROOT
      ResourceTags:
        - Key: Environment
          Value: workshop
        - Key: ManagedBy
          Value: ecr-create-on-push
    Type: AWS::ECR::RepositoryCreationTemplate
  EcrRegistryTemplateRole9295BC5C:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ecr.amazonaws.com
        Version: "2012-10-17"
      RoleName: workshop-ecr-template-role
    Type: AWS::IAM::Role
  EcrRegistryTemplateRoleDefaultPolicy760EC63A:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - ecr:CreateRepository
              - ecr:PutLifecyclePolicy
              - ecr:TagResource
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: EcrRegistryTemplateRoleDefaultPolicy760EC63A
      Roles:
        - Ref: EcrRegistryTemplateRole9295BC5C
    Type: AWS::IAM::Policy
  EksCloudWatchAgentRole1979BC79:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
              - sts:TagSession
            Effect: Allow
            Principal:
              Service: pods.eks.amazonaws.com
        Version: "2012-10-17"
      Description: EKS Pod Identity role for CloudWatch Observability add-on
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/CloudWatchAgentServerPolicy
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AWSXrayWriteOnlyAccess
      RoleName: workshop-eks-cloudwatch-agent-role
    Type: AWS::IAM::Role
  EksClusterB2BDED5B:
    DependsOn:
      - VpcIGW488B0FEB
      - VpcPrivateSubnet1DefaultRouteF704DE9F
      - VpcPrivateSubnet1RouteTable901BAEEE
      - VpcPrivateSubnet1RouteTableAssociation2BC202CB
      - VpcPrivateSubnet1Subnet67A4DBCB
      - VpcPrivateSubnet2DefaultRoute5FAC9901
      - VpcPrivateSubnet2RouteTable1EA00C9D
      - VpcPrivateSubnet2RouteTableAssociationFA51927B
      - VpcPrivateSubnet2SubnetC8EB537D
      - VpcPublicSubnet1DefaultRoute0F5C6C43
      - VpcPublicSubnet1EIP2293BAA3
      - VpcPublicSubnet1NATGateway8185E366
      - VpcPublicSubnet1RouteTable431DD755
      - VpcPublicSubnet1RouteTableAssociationBBCB7AA1
      - VpcPublicSubnet1Subnet8E8DEDC0
      - VpcPublicSubnet2DefaultRouteD629179A
      - VpcPublicSubnet2RouteTable77FB35FC
      - VpcPublicSubnet2RouteTableAssociation3AFE92E6
      - VpcPublicSubnet2SubnetA811849C
      - VpcC3027511
      - VpcVPCGW42EC8516
    Properties:
      AccessConfig:
        AuthenticationMode: API
      ComputeConfig:
        Enabled: true
        NodePools:
          - system
          - general-purpose
        NodeRoleArn:
          Fn::GetAtt:
            - EksClusterClusternodePoolRoleE206FBFC
            - Arn
      KubernetesNetworkConfig:
        ElasticLoadBalancing:
          Enabled: true
        IpFamily: ipv4
      Name: workshop-eks
      ResourcesVpcConfig:
        EndpointPrivateAccess: true
        EndpointPublicAccess: true
        SecurityGroupIds:
          - Fn::GetAtt:
              - IdeInternalSecurityGroupB0A5D76B
              - GroupId
        SubnetIds:
          - Ref: VpcPublicSubnet1Subnet8E8DEDC0
          - Ref: VpcPublicSubnet2SubnetA811849C
          - Ref: VpcPrivateSubnet1Subnet67A4DBCB
          - Ref: VpcPrivateSubnet2SubnetC8EB537D
      RoleArn:
        Fn::GetAtt:
          - EksClusterRoleD18DF32F
          - Arn
      StorageConfig:
        BlockStorage:
          Enabled: true
      Version: "1.34"
    Type: AWS::EKS::Cluster
  EksClusterClusterSecurityGroupfromWorkshopStackThreadAnalysisSecurityGroup80EDCDE3443FFB1A901:
    Properties:
      Description: Allow Lambda access to Kubernetes API
      FromPort: 443
      GroupId:
        Fn::GetAtt:
          - EksClusterB2BDED5B
          - ClusterSecurityGroupId
      IpProtocol: tcp
      SourceSecurityGroupId:
        Fn::GetAtt:
          - ThreadAnalysisSecurityGroup28B00BCE
          - GroupId
      ToPort: 443
    Type: AWS::EC2::SecurityGroupIngress
  EksClusterClusternodePoolRoleE206FBFC:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonEKSWorkerNodePolicy
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
    Type: AWS::IAM::Role
  EksClusterKubectlReadyBarrierA32D1E84:
    DependsOn:
      - EksClusterB2BDED5B
    Properties:
      Type: String
      Value: aws:cdk:eks:kubectl-ready
    Type: AWS::SSM::Parameter
  EksClusterRoleD18DF32F:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
              - sts:TagSession
            Effect: Allow
            Principal:
              Service: eks.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonEKSClusterPolicy
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonEKSComputePolicy
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonEKSBlockStoragePolicy
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonEKSLoadBalancingPolicy
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonEKSNetworkingPolicy
    Type: AWS::IAM::Role
  EksInstanceAccessEntry1D317291:
    Properties:
      AccessPolicies:
        - AccessScope:
            Type: cluster
          PolicyArn:
            Fn::Join:
              - ""
              - - "arn:"
                - Ref: AWS::Partition
                - :eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy
      ClusterName:
        Ref: EksClusterB2BDED5B
      PrincipalArn:
        Fn::GetAtt:
          - IdeRole4650E22E
          - Arn
      Type: STANDARD
    Type: AWS::EKS::AccessEntry
  EksMountpointS3DriverB7062BF9:
    Properties:
      AddonName: aws-mountpoint-s3-csi-driver
      ClusterName:
        Ref: EksClusterB2BDED5B
    Type: AWS::EKS::Addon
  EksParticipantAccessEntryCBA5D5C0:
    Properties:
      AccessPolicies:
        - AccessScope:
            Type: cluster
          PolicyArn:
            Fn::Join:
              - ""
              - - "arn:"
                - Ref: AWS::Partition
                - :eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy
      ClusterName:
        Ref: EksClusterB2BDED5B
      PrincipalArn:
        Fn::Join:
          - ""
          - - "arn:aws:iam::"
            - Ref: AWS::AccountId
            - :role/WSParticipantRole
      Type: STANDARD
    Type: AWS::EKS::AccessEntry
  EksPodIdentityAgent31D8BD3D:
    Properties:
      AddonName: eks-pod-identity-agent
      ClusterName:
        Ref: EksClusterB2BDED5B
    Type: AWS::EKS::Addon
  EksSecretsStoreDriverA84665C0:
    Properties:
      AddonName: aws-secrets-store-csi-driver-provider
      ClusterName:
        Ref: EksClusterB2BDED5B
    Type: AWS::EKS::Addon
  IdeDistribution042A6660:
    DeletionPolicy: Delete
    DependsOn:
      - IdeEipAssociationDFF81215
    Properties:
      DistributionConfig:
        DefaultCacheBehavior:
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
            - PUT
            - PATCH
            - POST
            - DELETE
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
          Compress: true
          OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3
          TargetOriginId: WorkshopStackIdeDistributionOrigin10FECA386
          ViewerProtocolPolicy: allow-all
        Enabled: true
        HttpVersion: http2
        IPV6Enabled: true
        Origins:
          - CustomOriginConfig:
              HTTPPort: 80
              OriginProtocolPolicy: http-only
              OriginSSLProtocols:
                - TLSv1.2
            DomainName:
              Fn::Join:
                - ""
                - - ec2-
                  - Fn::Select:
                      - 0
                      - Fn::Split:
                          - "."
                          - Fn::GetAtt:
                              - IdeElasticIP3327A0B5
                              - PublicIp
                  - "-"
                  - Fn::Select:
                      - 1
                      - Fn::Split:
                          - "."
                          - Fn::GetAtt:
                              - IdeElasticIP3327A0B5
                              - PublicIp
                  - "-"
                  - Fn::Select:
                      - 2
                      - Fn::Split:
                          - "."
                          - Fn::GetAtt:
                              - IdeElasticIP3327A0B5
                              - PublicIp
                  - "-"
                  - Fn::Select:
                      - 3
                      - Fn::Split:
                          - "."
                          - Fn::GetAtt:
                              - IdeElasticIP3327A0B5
                              - PublicIp
                  - .compute-1.amazonaws.com
            Id: WorkshopStackIdeDistributionOrigin10FECA386
    Type: AWS::CloudFront::Distribution
    UpdateReplacePolicy: Delete
  IdeEC2InstanceResource438B3605:
    DeletionPolicy: Delete
    Properties:
      IamInstanceProfileArn:
        Fn::GetAtt:
          - IdeInstanceProfile61B92038
          - Arn
      ImageId:
        Ref: SsmParameterValueawsserviceamiamazonlinuxlatestal2023amikernel61x8664C96584B6F00A464EAD1953AFF4B05118Parameter
      InstanceName: ide
      InstanceTypes: m6a.xlarge,m7a.xlarge
      SecurityGroupIds:
        Fn::Join:
          - ""
          - - Fn::GetAtt:
                - IdeSecurityGroup73B02454
                - GroupId
            - ","
            - Fn::GetAtt:
                - IdeInternalSecurityGroupB0A5D76B
                - GroupId
      ServiceToken:
        Fn::GetAtt:
          - IdeInstanceLauncherFunction803C5A2A
          - Arn
      SubnetIds:
        Fn::Join:
          - ""
          - - Ref: VpcPublicSubnet1Subnet8E8DEDC0
            - ","
            - Ref: VpcPublicSubnet2SubnetA811849C
      UserData:
        Fn::Base64:
          Fn::Join:
            - ""
            - - |-
                #!/bin/bash
                #!/bin/bash
                set -e

                # Minimal EC2 UserData script - downloads and runs full bootstrap
                # This keeps UserData under size limits while allowing unlimited bootstrap size

                # Configuration from CDK
                export GIT_BRANCH="main"
                export AWS_REGION="
              - Ref: AWS::Region
              - |-
                "
                export TEMPLATE_TYPE="java-on-aws-immersion-day"
                export ARCH="x86_64"
                export IDE_TYPE="code-editor"
                export WAIT_CONDITION_HANDLE_URL="
              - Ref: IdeWaitConditionHandleE8345861
              - |-
                "
                export PREFIX="workshop"

                # Setup logging - use PREFIX for log group name
                LOG_GROUP_NAME="workshop-ide-bootstrap-$(date +%Y%m%d-%H%M%S)"
                echo "Bootstrap logs will be written to CloudWatch log group: $LOG_GROUP_NAME"

                # Install CloudWatch agent for logging
                dnf install -y amazon-cloudwatch-agent

                # Create CloudWatch agent configuration
                cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json << EOF
                {
                  "logs": {
                    "logs_collected": {
                      "files": {
                        "collect_list": [
                          {
                            "file_path": "/var/log/bootstrap.log",
                            "log_group_name": "$LOG_GROUP_NAME",
                            "log_stream_name": "{instance_id}",
                            "retention_in_days": 7
                          }
                        ]
                      }
                    }
                  }
                }
                EOF

                # Start CloudWatch agent
                /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
                  -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s

                # Redirect all output to log file and console
                exec > >(tee -a /var/log/bootstrap.log)
                exec 2>&1

                echo "UserData started at $(date) - Logging to $LOG_GROUP_NAME"

                # Set up error trap for UserData failures (before bootstrap.sh takes over)
                trap 'echo "UserData failed at line $LINENO"; /opt/aws/bin/cfn-signal -e 1 "
              - Ref: IdeWaitConditionHandleE8345861
              - |-
                " 2>/dev/null || true; exit 1' ERR

                # Install git (required for cloning repository)
                echo "Installing git..."
                dnf install -y git

                # Clone repository to ec2-user home directory
                clone_repository() {
                    local max_attempts=5
                    local delay=5

                    for attempt in $(seq 1 $max_attempts); do
                        echo "Clone attempt $attempt of $max_attempts"

                        # Remove existing directory if it exists
                        sudo -u ec2-user rm -rf /home/ec2-user/java-on-aws

                        # Clone as ec2-user to their home directory
                        if sudo -u ec2-user git clone https://github.com/aws-samples/java-on-aws.git /home/ec2-user/java-on-aws; then
                            # Checkout the correct branch as ec2-user
                            if sudo -u ec2-user bash -c "cd /home/ec2-user/java-on-aws && git checkout $GIT_BRANCH"; then
                                echo "Successfully cloned repository and checked out branch $GIT_BRANCH on attempt $attempt"
                                return 0
                            else
                                echo "Failed to checkout branch $GIT_BRANCH on attempt $attempt"
                            fi
                        else
                            echo "Failed to clone repository on attempt $attempt"
                        fi

                        if [ $attempt -lt $max_attempts ]; then
                            echo "Clone failed on attempt $attempt, waiting ${delay}s before retry..."
                            sleep $delay
                        fi
                    done

                    echo "All clone attempts failed after $max_attempts tries"
                    return 1
                }

                if clone_repository; then
                    # Make scripts executable
                    sudo -u ec2-user chmod +x /home/ec2-user/java-on-aws/infra/scripts/ide/*.sh

                    echo "Executing full bootstrap script..."
                    # Run bootstrap script as root from the cloned directory
                    if cd /home/ec2-user/java-on-aws && WAIT_CONDITION_HANDLE_URL="
              - Ref: IdeWaitConditionHandleE8345861
              - |-
                " infra/scripts/ide/bootstrap.sh "$GIT_BRANCH" "$TEMPLATE_TYPE"; then
                        echo "Bootstrap completed successfully"
                        # Bootstrap script already signaled success
                    else
                        echo "FATAL: Bootstrap script failed"
                        /opt/aws/bin/cfn-signal -e 1 "
              - Ref: IdeWaitConditionHandleE8345861
              - |-
                "
                        exit 1
                    fi
                else
                    echo "FATAL: Could not clone repository"
                    /opt/aws/bin/cfn-signal -e 1 "
              - Ref: IdeWaitConditionHandleE8345861
              - |-
                "
                    exit 1
                fi
      VolumeSize: "50"
    Type: AWS::CloudFormation::CustomResource
    UpdateReplacePolicy: Delete
  IdeEipAssociationDFF81215:
    Properties:
      AllocationId:
        Fn::GetAtt:
          - IdeElasticIP3327A0B5
          - AllocationId
      InstanceId:
        Fn::GetAtt:
          - IdeEC2InstanceResource438B3605
          - InstanceId
    Type: AWS::EC2::EIPAssociation
  IdeElasticIP3327A0B5:
    Properties:
      Domain: vpc
    Type: AWS::EC2::EIP
  IdeInstanceLauncherFunction803C5A2A:
    DependsOn:
      - IdeLambdaRoleDefaultPolicy099093D2
      - IdeLambdaRole82392143
    Properties:
      Code:
        ZipFile: |-
          import boto3
          import traceback
          import cfnresponse

          ec2 = boto3.client('ec2')

          def lambda_handler(event, context):
              print(f'Event: {event}')
              responseData = {}
              status = cfnresponse.SUCCESS
              physical_id = event.get('PhysicalResourceId', 'InstanceLauncher')

              try:
                  if event['RequestType'] == 'Delete':
                      # Terminate the instance if it exists
                      instance_id = event.get('PhysicalResourceId')
                      if instance_id and instance_id.startswith('i-'):
                          try:
                              ec2.terminate_instances(InstanceIds=[instance_id])
                              print(f'Terminated instance: {instance_id}')
                          except Exception as e:
                              print(f'Error terminating instance: {e}')
                      responseData = {'Message': 'Instance terminated'}
                      cfnresponse.send(event, context, status, responseData, physical_id)
                      return

                  if event['RequestType'] == 'Update':
                      # For updates, return existing instance
                      instance_id = event.get('PhysicalResourceId')
                      if instance_id and instance_id.startswith('i-'):
                          responseData = {'InstanceId': instance_id}
                          cfnresponse.send(event, context, status, responseData, instance_id)
                          return

                  # Create new instance
                  props = event['ResourceProperties']
                  subnet_ids = props['SubnetIds'].split(',')
                  instance_types = props['InstanceTypes'].split(',')

                  instance_id = None
                  last_error = None

                  # Try each instance type across all AZs
                  for instance_type in instance_types:
                      for subnet_id in subnet_ids:
                          try:
                              print(f'Attempting to launch {instance_type} in subnet {subnet_id}')

                              response = ec2.run_instances(
                                  ImageId=props['ImageId'],
                                  InstanceType=instance_type,
                                  SubnetId=subnet_id,
                                  SecurityGroupIds=props['SecurityGroupIds'].split(','),
                                  IamInstanceProfile={'Arn': props['IamInstanceProfileArn']},
                                  BlockDeviceMappings=[{
                                      'DeviceName': '/dev/xvda',
                                      'Ebs': {
                                          'VolumeSize': int(props['VolumeSize']),
                                          'VolumeType': 'gp3',
                                          'DeleteOnTermination': True,
                                          'Encrypted': True
                                      }
                                  }],
                                  TagSpecifications=[{
                                      'ResourceType': 'instance',
                                      'Tags': [
                                          {'Key': 'Name', 'Value': props['InstanceName']},
                                          {'Key': 'Workshop', 'Value': 'true'}
                                      ]
                                  }],
                                  UserData=props.get('UserData', ''),
                                  MinCount=1,
                                  MaxCount=1
                              )

                              instance_id = response['Instances'][0]['InstanceId']
                              print(f'Successfully launched instance {instance_id} ({instance_type} in {subnet_id})')

                              # Wait for instance to reach running state before returning
                              print(f'Waiting for instance {instance_id} to reach running state...')
                              waiter = ec2.get_waiter('instance_running')
                              waiter.wait(
                                  InstanceIds=[instance_id],
                                  WaiterConfig={
                                      'Delay': 10,
                                      'MaxAttempts': 30  # 30 * 10 = 300 seconds (5 minutes) max wait
                                  }
                              )
                              print(f'Instance {instance_id} is now running')

                              responseData = {
                                  'InstanceId': instance_id,
                                  'InstanceType': instance_type,
                                  'SubnetId': subnet_id
                              }
                              cfnresponse.send(event, context, status, responseData, instance_id)
                              return

                          except Exception as e:
                              error_msg = str(e)
                              print(f'Failed to launch {instance_type} in {subnet_id}: {error_msg}')

                              # Check if it's a retryable error (capacity or instance type issues)
                              retryable_errors = [
                                  'InsufficientInstanceCapacity',  # No capacity in AZ
                                  'Unsupported',                    # Instance type not supported
                                  'InstanceLimitExceeded',          # Hit instance limit
                                  'VcpuLimitExceeded',              # Hit vCPU limit
                                  'InvalidParameterValue',          # Invalid instance type or config
                              ]

                              if any(err in error_msg for err in retryable_errors):
                                  last_error = error_msg
                                  continue  # Try next combination
                              else:
                                  # Other error (permissions, network, etc), fail immediately
                                  raise

                  # All attempts failed
                  status = cfnresponse.FAILED
                  responseData = {'Error': f'No capacity available. Last error: {last_error}'}

              except Exception as e:
                  status = cfnresponse.FAILED
                  tb_err = traceback.format_exc()
                  print(tb_err)
                  responseData = {'Error': tb_err}

              cfnresponse.send(event, context, status, responseData, physical_id)
      FunctionName: workshop-ide-launcher
      Handler: index.lambda_handler
      Role:
        Fn::GetAtt:
          - IdeLambdaRole82392143
          - Arn
      Runtime: python3.13
      Timeout: 300
    Type: AWS::Lambda::Function
  IdeInstanceProfile61B92038:
    Properties:
      InstanceProfileName: workshop-ide-instance-profile
      Roles:
        - Ref: IdeRole4650E22E
    Type: AWS::IAM::InstanceProfile
  IdeInternalSecurityGroupB0A5D76B:
    Properties:
      GroupDescription: IDE internal security group
      GroupName: workshop-ide-internal-sg
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::SecurityGroup
  IdeInternalSecurityGroupfromWorkshopStackIdeInternalSecurityGroup2A6A3A7DALLTRAFFIC101F9997:
    Properties:
      Description: Allow all internal traffic
      GroupId:
        Fn::GetAtt:
          - IdeInternalSecurityGroupB0A5D76B
          - GroupId
      IpProtocol: "-1"
      SourceSecurityGroupId:
        Fn::GetAtt:
          - IdeInternalSecurityGroupB0A5D76B
          - GroupId
    Type: AWS::EC2::SecurityGroupIngress
  IdeInternalSecurityGrouptoWorkshopStackIdeInternalSecurityGroup2A6A3A7DALLTRAFFICCB660737:
    Properties:
      Description: Allow all internal traffic
      DestinationSecurityGroupId:
        Fn::GetAtt:
          - IdeInternalSecurityGroupB0A5D76B
          - GroupId
      GroupId:
        Fn::GetAtt:
          - IdeInternalSecurityGroupB0A5D76B
          - GroupId
      IpProtocol: "-1"
    Type: AWS::EC2::SecurityGroupEgress
  IdeLambdaRole82392143:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Type: AWS::IAM::Role
  IdeLambdaRoleDefaultPolicy099093D2:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - ec2:CreateTags
              - ec2:DescribeInstanceStatus
              - ec2:DescribeInstances
              - ec2:DescribeManagedPrefixLists
              - ec2:DescribeSubnets
              - ec2:RunInstances
              - ec2:TerminateInstances
              - iam:PassRole
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
              - ssm:DescribeInstanceInformation
              - ssm:GetCommandInvocation
              - ssm:SendCommand
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: IdeLambdaRoleDefaultPolicy099093D2
      Roles:
        - Ref: IdeLambdaRole82392143
    Type: AWS::IAM::Policy
  IdePasswordFunctionFD1F967F:
    DependsOn:
      - IdePasswordFunctionServiceRoleDefaultPolicy282A360C
      - IdePasswordFunctionServiceRole971421B6
    Properties:
      Code:
        ZipFile: |-
          import boto3
          import json
          import traceback
          import cfnresponse

          secretsmanager = boto3.client('secretsmanager')

          def lambda_handler(event, context):
              print(f'Event: {event}')
              responseData = {}
              status = cfnresponse.SUCCESS
              physical_id = event.get('PhysicalResourceId', 'PasswordExporter')

              try:
                  if event['RequestType'] == 'Delete':
                      # Nothing to clean up for password export
                      responseData = {'Message': 'Password exporter deleted'}
                      cfnresponse.send(event, context, status, responseData, physical_id)
                      return

                  if event['RequestType'] in ['Create', 'Update']:
                      # Get password from Secrets Manager
                      props = event['ResourceProperties']
                      password_name = props['PasswordName']

                      print('Retrieving password from secret in Secrets Manager')

                      response = secretsmanager.get_secret_value(SecretId=password_name)
                      secret_data = json.loads(response['SecretString'])

                      # Return the password value for CloudFormation output
                      responseData = {
                          'password': secret_data['password']
                      }

                      print('Successfully retrieved password from Secrets Manager')

              except Exception as e:
                  status = cfnresponse.FAILED
                  tb_err = traceback.format_exc()
                  print(tb_err)
                  responseData = {'Error': tb_err}

              cfnresponse.send(event, context, status, responseData, physical_id)
      FunctionName: workshop-ide-password
      Handler: index.lambda_handler
      Role:
        Fn::GetAtt:
          - IdePasswordFunctionServiceRole971421B6
          - Arn
      Runtime: python3.13
      Timeout: 180
    Type: AWS::Lambda::Function
  IdePasswordFunctionServiceRole971421B6:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Type: AWS::IAM::Role
  IdePasswordFunctionServiceRoleDefaultPolicy282A360C:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
              Ref: IdePasswordSecretF907B9F2
        Version: "2012-10-17"
      PolicyName: IdePasswordFunctionServiceRoleDefaultPolicy282A360C
      Roles:
        - Ref: IdePasswordFunctionServiceRole971421B6
    Type: AWS::IAM::Policy
  IdePasswordResource07883F17:
    DeletionPolicy: Delete
    Properties:
      PasswordName:
        Fn::Join:
          - "-"
          - - Fn::Select:
                - 0
                - Fn::Split:
                    - "-"
                    - Fn::Select:
                        - 6
                        - Fn::Split:
                            - ":"
                            - Ref: IdePasswordSecretF907B9F2
            - Fn::Select:
                - 1
                - Fn::Split:
                    - "-"
                    - Fn::Select:
                        - 6
                        - Fn::Split:
                            - ":"
                            - Ref: IdePasswordSecretF907B9F2
            - Fn::Select:
                - 2
                - Fn::Split:
                    - "-"
                    - Fn::Select:
                        - 6
                        - Fn::Split:
                            - ":"
                            - Ref: IdePasswordSecretF907B9F2
      ServiceToken:
        Fn::GetAtt:
          - IdePasswordFunctionFD1F967F
          - Arn
    Type: AWS::CloudFormation::CustomResource
    UpdateReplacePolicy: Delete
  IdePasswordSecretF907B9F2:
    DeletionPolicy: Delete
    Properties:
      GenerateSecretString:
        ExcludeCharacters: '"@/\\'
        ExcludePunctuation: true
        GenerateStringKey: password
        IncludeSpace: false
        PasswordLength: 32
        SecretStringTemplate: '{"password":""}'
      Name: workshop-ide-password
    Type: AWS::SecretsManager::Secret
    UpdateReplacePolicy: Delete
  IdePrefixListLookupFunction9E5A63DE:
    DependsOn:
      - IdeLambdaRoleDefaultPolicy099093D2
      - IdeLambdaRole82392143
    Properties:
      Code:
        ZipFile: |-
          from __future__ import print_function
          import boto3
          import traceback
          import cfnresponse

          def lambda_handler(event, context):
              print('Event: {}'.format(event))
              print('context: {}'.format(context))
              responseData = {}

              status = cfnresponse.SUCCESS

              if event['RequestType'] == 'Delete':
                  responseData = {'Success': 'Custom Resource removed'}
                  cfnresponse.send(event, context, status, responseData, 'CustomResourcePhysicalID')
              else:
                  try:
                      # Open AWS clients
                      ec2 = boto3.client('ec2')

                      res = ec2.describe_managed_prefix_lists(
                         Filters=[{
                            'Name': 'prefix-list-name',
                            'Values': ['com.amazonaws.global.cloudfront.origin-facing']
                         }]
                      )

                      responseData = {'PrefixListId': str(res['PrefixLists'][0]['PrefixListId'])}
                  except Exception as e:
                      status = cfnresponse.FAILED
                      tb_err = traceback.format_exc()
                      print(tb_err)
                      responseData = {'Error': tb_err}
                  finally:
                      cfnresponse.send(event, context, status, responseData, 'CustomResourcePhysicalID')
      FunctionName: workshop-ide-prefixlist
      Handler: index.lambda_handler
      Role:
        Fn::GetAtt:
          - IdeLambdaRole82392143
          - Arn
      Runtime: python3.13
      Timeout: 180
    Type: AWS::Lambda::Function
  IdePrefixListResourceD2EAC007:
    DeletionPolicy: Delete
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - IdePrefixListLookupFunction9E5A63DE
          - Arn
    Type: AWS::CloudFormation::CustomResource
    UpdateReplacePolicy: Delete
  IdeRole4650E22E:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/ReadOnlyAccess
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AmazonSSMManagedInstanceCore
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/CloudWatchAgentServerPolicy
        - Ref: IdeUserPolicy2460FC7D
      RoleName: workshop-ide-user
    Type: AWS::IAM::Role
  IdeRoleDefaultPolicyFD4BDE67:
    Properties:
      PolicyDocument:
        Statement:
          - Action: cloudformation:SignalResource
            Effect: Allow
            Resource: "*"
          - Action:
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
              Ref: IdePasswordSecretF907B9F2
        Version: "2012-10-17"
      PolicyName: IdeRoleDefaultPolicyFD4BDE67
      Roles:
        - Ref: IdeRole4650E22E
    Type: AWS::IAM::Policy
  IdeSecurityGroup73B02454:
    Properties:
      GroupDescription: IDE security group
      GroupName: workshop-ide-cloudfront-sg
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::SecurityGroup
  IdeSecurityGroupfromIndirectPeer80C006C8A1:
    Properties:
      Description: HTTP from CloudFront only
      FromPort: 80
      GroupId:
        Fn::GetAtt:
          - IdeSecurityGroup73B02454
          - GroupId
      IpProtocol: tcp
      SourcePrefixListId:
        Fn::GetAtt:
          - IdePrefixListResourceD2EAC007
          - PrefixListId
      ToPort: 80
    Type: AWS::EC2::SecurityGroupIngress
  IdeUserPolicy2460FC7D:
    Properties:
      Description: ""
      Path: /
      PolicyDocument:
        Statement:
          - Action: aws-marketplace:Subscribe
            Condition:
              ForAllValues:StringEquals:
                aws-marketplace:ProductId:
                  - prod-jhuafngbly644
                  - prod-mxcfnwvpd6kb4
                  - prod-4pmewlybdftbs
              "Null":
                aws-marketplace:ProductId: "false"
            Effect: Allow
            Resource: "*"
            Sid: MarketplaceSubscribeClaude45Opus45Sonnet4Sonnet
          - Action:
              - acm:*
              - apigateway:*
              - application-autoscaling:*
              - application-signals:*
              - aws-marketplace:Unsubscribe
              - aws-marketplace:ViewSubscriptions
              - bedrock-agentcore:*
              - bedrock:*
              - cloudformation:*
              - cloudfront:*
              - cloudtrail:*
              - cloudwatch:*
              - codewhisperer:*
              - cognito-idp:*
              - ec2:*
              - ecr:*
              - ecs:*
              - eks:*
              - elasticloadbalancing:*
              - events:*
              - lambda:*
              - logs:*
              - q:*
              - rds:*
              - s3:*
              - s3vectors:*
              - secretsmanager:*
              - ssm:*
              - sts:*
              - tag:*
              - xray:*
            Effect: Allow
            Resource: "*"
            Sid: AllowedServices
          - Action: iam:PassRole
            Effect: Allow
            Resource:
              - !Sub arn:aws:iam::${AWS::AccountId}:role/ai-jvm-analyzer*
              - !Sub arn:aws:iam::${AWS::AccountId}:role/aiagent*
              - !Sub arn:aws:iam::${AWS::AccountId}:role/mcpserver*
              - !Sub arn:aws:iam::${AWS::AccountId}:role/service-role/unicorn*
              - !Sub arn:aws:iam::${AWS::AccountId}:role/unicorn*
              - !Sub arn:aws:iam::${AWS::AccountId}:role/workshop*
            Sid: PassRole
          - Action: iam:CreateServiceLinkedRole
            Effect: Allow
            Resource:
              - arn:aws:iam::*:role/aws-service-role/application-signals.cloudwatch.amazonaws.com/*
              - arn:aws:iam::*:role/aws-service-role/cloudtrail.amazonaws.com/*
            Sid: CreateServiceLinkedRole
          - Action:
              - iam:GetRole
              - iam:ListRoles
            Effect: Allow
            Resource: "*"
            Sid: GetRole
          - Action: ec2:RunInstances
            Condition:
              StringLike:
                ec2:InstanceType:
                  - "*4xlarge"
                  - "*6xlarge"
                  - "*8xlarge"
                  - "*9xlarge"
                  - "*10xlarge"
                  - "*12xlarge"
                  - "*16xlarge"
                  - "*18xlarge"
                  - "*24xlarge"
                  - f1*
                  - x1*
                  - z1*
                  - "*metal"
            Effect: Deny
            Resource: arn:aws:ec2:*:*:instance/*
            Sid: DenyXXLInstances
          - Action:
              - dynamodb:PurchaseReservedCapacityOfferings
              - ec2:ModifyReservedInstances
              - ec2:PurchaseHostReservation
              - ec2:PurchaseReservedInstancesOffering
              - ec2:PurchaseScheduledInstances
              - rds:PurchaseReservedDBInstancesOffering
            Effect: Deny
            Resource: "*"
            Sid: DenyReservations
        Version: "2012-10-17"
    Type: AWS::IAM::ManagedPolicy
  IdeWaitConditionCC35C186:
    DependsOn:
      - IdeEC2InstanceResource438B3605
    Properties:
      Count: 1
      Handle:
        Ref: IdeWaitConditionHandleE8345861
      Timeout: "1800"
    Type: AWS::CloudFormation::WaitCondition
  IdeWaitConditionHandleE8345861:
    Type: AWS::CloudFormation::WaitConditionHandle
  ThreadAnalysisLambda3EE9B29D:
    DependsOn:
      - ThreadAnalysisLambdaRoleDefaultPolicyC7AD40BA
      - ThreadAnalysisLambdaRole00E8F59E
      - VpcPrivateSubnet1DefaultRouteF704DE9F
      - VpcPrivateSubnet1RouteTableAssociation2BC202CB
      - VpcPrivateSubnet2DefaultRoute5FAC9901
      - VpcPrivateSubnet2RouteTableAssociationFA51927B
    Properties:
      Code:
        ZipFile: |
          """
          Thread Dump Lambda - Placeholder for CDK deployment.
          This is a minimal placeholder that will be replaced by the full implementation
          via post-deployment script (infra/scripts/setup/thread-dump-lambda/).

          The full implementation includes:
          - EKS client for thread dump collection via kubectl exec
          - ECS client for thread dump collection via container IP
          - Bedrock integration for AI-powered thread analysis
          - S3 storage for thread dumps and analysis results
          - Grafana webhook authentication
          """
          import json
          import logging
          import os

          logger = logging.getLogger()
          logger.setLevel(logging.INFO)

          def lambda_handler(event, context):
              """
              Placeholder handler - returns instructions for full deployment.
              Run the post-deployment script to enable full functionality.
              """
              logger.info(f'Thread Dump Lambda invoked (placeholder)')
              logger.info(f'Event: {json.dumps(event)}')

              return {
                  'statusCode': 200,
                  'headers': {
                      'Content-Type': 'application/json',
                      'Access-Control-Allow-Origin': '*'
                  },
                  'body': json.dumps({
                      'message': 'Thread dump Lambda placeholder - run post-deployment script for full functionality',
                      'instructions': 'Execute: ~/java-on-aws/infra/scripts/setup/thread-dump-lambda/deploy.sh',
                      'function_name': context.function_name,
                      'request_id': context.aws_request_id
                  })
              }
      Environment:
        Variables:
          EKS_CLUSTER_NAME:
            Ref: EksClusterB2BDED5B
          S3_BUCKET_NAME:
            Ref: WorkshopBucketFD5BC43F
          S3_THREAD_DUMPS_PREFIX: thread-dumps/
          SECRET_NAME: workshop-ide-password
      FunctionName: workshop-thread-dump-lambda
      Handler: index.lambda_handler
      MemorySize: 512
      Role:
        Fn::GetAtt:
          - ThreadAnalysisLambdaRole00E8F59E
          - Arn
      Runtime: python3.13
      Timeout: 300
      VpcConfig:
        SecurityGroupIds:
          - Fn::GetAtt:
              - ThreadAnalysisSecurityGroup28B00BCE
              - GroupId
        SubnetIds:
          - Ref: VpcPrivateSubnet1Subnet67A4DBCB
          - Ref: VpcPrivateSubnet2SubnetC8EB537D
    Type: AWS::Lambda::Function
  ThreadAnalysisLambdaAccessEntryF884F8C2:
    Properties:
      AccessPolicies:
        - AccessScope:
            Type: cluster
          PolicyArn:
            Fn::Join:
              - ""
              - - "arn:"
                - Ref: AWS::Partition
                - :eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy
      ClusterName:
        Ref: EksClusterB2BDED5B
      PrincipalArn:
        Fn::GetAtt:
          - ThreadAnalysisLambdaRole00E8F59E
          - Arn
      Type: STANDARD
    Type: AWS::EKS::AccessEntry
  ThreadAnalysisLambdaFunctionUrl1F411C0A:
    DependsOn:
      - VpcPrivateSubnet1DefaultRouteF704DE9F
      - VpcPrivateSubnet1RouteTableAssociation2BC202CB
      - VpcPrivateSubnet2DefaultRoute5FAC9901
      - VpcPrivateSubnet2RouteTableAssociationFA51927B
    Properties:
      AuthType: NONE
      TargetFunctionArn:
        Fn::GetAtt:
          - ThreadAnalysisLambda3EE9B29D
          - Arn
    Type: AWS::Lambda::Url
  ThreadAnalysisLambdaRole00E8F59E:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      Description: Role for Thread Dump Lambda to access Bedrock, EKS, and ECS
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      RoleName: workshop-thread-dump-lambda-role
    Type: AWS::IAM::Role
  ThreadAnalysisLambdaRoleDefaultPolicyC7AD40BA:
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - bedrock:InvokeModel
              - bedrock:InvokeModelWithResponseStream
            Effect: Allow
            Resource:
              - arn:aws:bedrock:*:*:foundation-model/anthropic.claude-sonnet-4-20250514-v1:0
              - arn:aws:bedrock:*:*:inference-profile/global.anthropic.claude-sonnet-4-20250514-v1:0
          - Action: secretsmanager:GetSecretValue
            Effect: Allow
            Resource: arn:aws:secretsmanager:*:*:secret:workshop-ide-password*
          - Action:
              - ecs:DescribeClusters
              - ecs:DescribeServices
              - ecs:DescribeTasks
              - ecs:ExecuteCommand
              - ecs:ListTasks
              - eks:AccessKubernetesApi
              - eks:DescribeCluster
              - eks:ListClusters
              - sts:GetCallerIdentity
            Effect: Allow
            Resource: "*"
          - Action:
              - s3:Abort*
              - s3:DeleteObject*
              - s3:GetBucket*
              - s3:GetObject*
              - s3:List*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - WorkshopBucketFD5BC43F
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - WorkshopBucketFD5BC43F
                        - Arn
                    - /*
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:aws:lambda:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :function:workshop-thread-dump-lambda
        Version: "2012-10-17"
      PolicyName: ThreadAnalysisLambdaRoleDefaultPolicyC7AD40BA
      Roles:
        - Ref: ThreadAnalysisLambdaRole00E8F59E
    Type: AWS::IAM::Policy
  ThreadAnalysisLambdainvokefunctionF0D39245:
    DependsOn:
      - VpcPrivateSubnet1DefaultRouteF704DE9F
      - VpcPrivateSubnet1RouteTableAssociation2BC202CB
      - VpcPrivateSubnet2DefaultRoute5FAC9901
      - VpcPrivateSubnet2RouteTableAssociationFA51927B
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - ThreadAnalysisLambda3EE9B29D
          - Arn
      InvokedViaFunctionUrl: true
      Principal: "*"
    Type: AWS::Lambda::Permission
  ThreadAnalysisLambdainvokefunctionurlEA9E1E5F:
    DependsOn:
      - VpcPrivateSubnet1DefaultRouteF704DE9F
      - VpcPrivateSubnet1RouteTableAssociation2BC202CB
      - VpcPrivateSubnet2DefaultRoute5FAC9901
      - VpcPrivateSubnet2RouteTableAssociationFA51927B
    Properties:
      Action: lambda:InvokeFunctionUrl
      FunctionName:
        Fn::GetAtt:
          - ThreadAnalysisLambda3EE9B29D
          - Arn
      FunctionUrlAuthType: NONE
      Principal: "*"
    Type: AWS::Lambda::Permission
  ThreadAnalysisLogGroup7EC7074A:
    DeletionPolicy: Delete
    Properties:
      LogGroupName: /aws/lambda/workshop-thread-dump-lambda
      RetentionInDays: 7
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Delete
  ThreadAnalysisSecurityGroup28B00BCE:
    Properties:
      GroupDescription: Security group for Thread Dump Lambda function
      GroupName: workshop-thread-dump-lambda-sg
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::SecurityGroup
  UnicornStoreSpringEcrEBC03514:
    DeletionPolicy: Delete
    Properties:
      EmptyOnDelete: true
      ImageScanningConfiguration:
        ScanOnPush: true
      RepositoryName: unicorn-store-spring
    Type: AWS::ECR::Repository
    UpdateReplacePolicy: Delete
  UnicornUnicornEventBusB728845C:
    Properties:
      Name: unicorns
    Type: AWS::Events::EventBus
  UnicornUnicornStoreDatabaseSetupFunction04E12F8B:
    DependsOn:
      - UnicornUnicornStoreDatabaseSetupFunctionServiceRoleDefaultPolicy00D62509
      - UnicornUnicornStoreDatabaseSetupFunctionServiceRole61942171
      - VpcPrivateSubnet1DefaultRouteF704DE9F
      - VpcPrivateSubnet1RouteTableAssociation2BC202CB
      - VpcPrivateSubnet2DefaultRoute5FAC9901
      - VpcPrivateSubnet2RouteTableAssociationFA51927B
    Properties:
      Code:
        ZipFile: |-
          import traceback
          import cfnresponse
          import boto3
          import json
          import time
          from botocore.exceptions import ClientError

          def get_cluster_arn(cluster_id, region, account_id):
              return f"arn:aws:rds:{region}:{account_id}:cluster:{cluster_id}"

          def wait_for_database_availability(rds_data, cluster_arn, secret_arn, database, max_attempts=10, delay=5):
              """Wait for the database to become available"""
              for attempt in range(1, max_attempts + 1):
                  try:
                      print(f"Checking database availability (attempt {attempt}/{max_attempts})...")
                      rds_data.execute_statement(
                          resourceArn=cluster_arn,
                          secretArn=secret_arn,
                          database=database,
                          sql="SELECT 1"
                      )
                      print("Database is available!")
                      return True
                  except Exception as e:
                      print(f"Database not yet available: {str(e)}. Retrying in {delay} seconds...")
                      time.sleep(delay)

              print(f"Database did not become available after {max_attempts} attempts")
              return False

          def execute_sql_with_retry(rds_data, cluster_arn, secret_arn, database, sql, max_retries=5, backoff_factor=2):
              """Execute SQL with exponential backoff retry logic"""
              retry_count = 0

              while retry_count <= max_retries:
                  try:
                      response = rds_data.execute_statement(
                          resourceArn=cluster_arn,
                          secretArn=secret_arn,
                          database=database,
                          sql=sql
                      )
                      print(f"Executed SQL: {sql}")
                      return response
                  except ClientError as e:
                      error_code = e.response.get('Error', {}).get('Code', '')
                      error_message = str(e)

                      # Check if this is a retryable error
                      if "InternalServerErrorException" in error_code or "ServiceUnavailable" in error_code:
                          retry_count += 1
                          if retry_count <= max_retries:
                              wait_time = backoff_factor ** retry_count
                              print(f"Retryable error: {error_message}. Retrying in {wait_time} seconds...")
                              time.sleep(wait_time)
                          else:
                              print(f"Max retries reached for SQL: {sql}")
                              raise
                      else:
                          # Non-retryable error
                          print(f"Non-retryable error: {error_message}")
                          raise

          def lambda_handler(event, context):
              print('Event: {}'.format(event))
              print('context: {}'.format(context))
              responseData = {}
              status = cfnresponse.SUCCESS

              if event['RequestType'] == 'Delete':
                  cfnresponse.send(event, context, status, responseData, 'CustomResourcePhysicalID')
                  return

              try:
                  # Get secret name and SQL from resource properties
                  secret_name = event['ResourceProperties']['SecretName']
                  sql_statements = event['ResourceProperties']['SqlStatements']

                  # Get AWS account ID and region
                  sts = boto3.client('sts')
                  caller_identity = sts.get_caller_identity()
                  account_id = caller_identity['Account']
                  region = boto3.session.Session().region_name
                  caller_arn = caller_identity['Arn']
                  print(f"Account ID: {account_id}, Region: {region}")
                  print(f"Caller ARN: {caller_arn}")

                  # Get the secret
                  secretsmanager = boto3.client('secretsmanager')
                  try:
                      secret_details = secretsmanager.describe_secret(
                          SecretId=secret_name
                      )
                      secret_arn = secret_details['ARN']
                      print("Secret ARN retrieved successfully.")
                  except ClientError as e:
                      print(f"Error retrieving secret details: {str(e)}")
                      raise

                  try:
                      secret_response = secretsmanager.get_secret_value(
                          SecretId=secret_name
                      )
                      secret = json.loads(secret_response['SecretString'])
                  except ClientError as e:
                      print(f"Error retrieving secret value: {str(e)}")
                      raise
                  except json.JSONDecodeError as e:
                      print(f"Error parsing secret JSON: {str(e)}")
                      raise

                  # Construct cluster ARN
                  cluster_arn = get_cluster_arn(
                      secret['dbClusterIdentifier'],
                      region,
                      account_id
                  )
                  print("Cluster ARN resolved successfully.")

                  # Initialize RDS Data API client
                  rds_data = boto3.client('rds-data')

                  # Wait for database to be available
                  if not wait_for_database_availability(rds_data, cluster_arn, secret_arn, secret['dbname']):
                      raise Exception("Database is not available after maximum wait time")

                  # Process SQL statements
                  statements = [stmt.strip() for stmt in sql_statements.split(';') if stmt.strip()]

                  for sql in statements:
                      try:
                          execute_sql_with_retry(
                              rds_data,
                              cluster_arn,
                              secret_arn,
                              secret['dbname'],
                              sql
                          )
                      except Exception as sql_error:
                          print(f"Error executing SQL: {sql}")
                          print(f"Error: {str(sql_error)}")
                          raise sql_error

                  responseData = {'Success': 'Finished database setup.'}

              except Exception as e:
                  status = cfnresponse.FAILED
                  tb_err = traceback.format_exc()
                  print(tb_err)
                  responseData = {'Error': tb_err}
              finally:
                  cfnresponse.send(event, context, status, responseData, 'CustomResourcePhysicalID')
      FunctionName: unicornstore-database-setup
      Handler: index.lambda_handler
      Role:
        Fn::GetAtt:
          - UnicornUnicornStoreDatabaseSetupFunctionServiceRole61942171
          - Arn
      Runtime: python3.13
      Timeout: 180
      VpcConfig:
        SecurityGroupIds:
          - Fn::GetAtt:
              - DatabaseSG562817C8
              - GroupId
        SubnetIds:
          - Ref: VpcPrivateSubnet1Subnet67A4DBCB
          - Ref: VpcPrivateSubnet2SubnetC8EB537D
    Type: AWS::Lambda::Function
  UnicornUnicornStoreDatabaseSetupFunctionServiceRole61942171:
    DependsOn:
      - VpcPrivateSubnet1DefaultRouteF704DE9F
      - VpcPrivateSubnet1RouteTableAssociation2BC202CB
      - VpcPrivateSubnet2DefaultRoute5FAC9901
      - VpcPrivateSubnet2RouteTableAssociationFA51927B
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
    Type: AWS::IAM::Role
  UnicornUnicornStoreDatabaseSetupFunctionServiceRoleDefaultPolicy00D62509:
    DependsOn:
      - VpcPrivateSubnet1DefaultRouteF704DE9F
      - VpcPrivateSubnet1RouteTableAssociation2BC202CB
      - VpcPrivateSubnet2DefaultRoute5FAC9901
      - VpcPrivateSubnet2RouteTableAssociationFA51927B
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
              - Ref: DatabaseSecret3B817195
              - Ref: DatabaseSecretAttachmentE5D1B020
          - Action:
              - rds-data:BatchExecuteStatement
              - rds-data:BeginTransaction
              - rds-data:CommitTransaction
              - rds-data:ExecuteStatement
              - rds-data:RollbackTransaction
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":rds:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - ":cluster:"
                  - Ref: DatabaseCluster5B53A178
        Version: "2012-10-17"
      PolicyName: UnicornUnicornStoreDatabaseSetupFunctionServiceRoleDefaultPolicy00D62509
      Roles:
        - Ref: UnicornUnicornStoreDatabaseSetupFunctionServiceRole61942171
    Type: AWS::IAM::Policy
  UnicornUnicornStoreDatabaseSetupResourceCDB8BDDF:
    DeletionPolicy: Delete
    DependsOn:
      - DatabaseClusterDatabaseWriterF4C0B9A6
      - DatabaseCluster5B53A178
      - DatabaseClusterSubnets5540150D
    Properties:
      SecretName:
        Fn::Join:
          - "-"
          - - Fn::Select:
                - 0
                - Fn::Split:
                    - "-"
                    - Fn::Select:
                        - 6
                        - Fn::Split:
                            - ":"
                            - Ref: DatabaseSecret3B817195
            - Fn::Select:
                - 1
                - Fn::Split:
                    - "-"
                    - Fn::Select:
                        - 6
                        - Fn::Split:
                            - ":"
                            - Ref: DatabaseSecret3B817195
            - Fn::Select:
                - 2
                - Fn::Split:
                    - "-"
                    - Fn::Select:
                        - 6
                        - Fn::Split:
                            - ":"
                            - Ref: DatabaseSecret3B817195
      ServiceToken:
        Fn::GetAtt:
          - UnicornUnicornStoreDatabaseSetupFunction04E12F8B
          - Arn
      SqlStatements: |
        CREATE TABLE IF NOT EXISTS unicorns(id TEXT DEFAULT gen_random_uuid() PRIMARY KEY, name TEXT, age TEXT, size TEXT, type TEXT);
        CREATE EXTENSION IF NOT EXISTS vector;
    Type: AWS::CloudFormation::CustomResource
    UpdateReplacePolicy: Delete
  UnicornUnicornStoreEcsInfrastructureRoleEDFFC1E6:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ecs.amazonaws.com
        Version: "2012-10-17"
      Description: ECS infrastructure role for Express Mode services
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AmazonECSInfrastructureRoleforExpressGatewayServices
      Path: /service-role/
      RoleName: unicornstore-ecs-infrastructure-role
    Type: AWS::IAM::Role
  UnicornUnicornStoreEcsTaskExecutionRoleC2148AE8:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: "2012-10-17"
      Description: ECS task execution role for pulling images and injecting secrets
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Path: /service-role/
      RoleName: unicornstore-ecs-task-execution-role
    Type: AWS::IAM::Role
  UnicornUnicornStoreEcsTaskExecutionRoleDefaultPolicy3FC9EFEE:
    Properties:
      PolicyDocument:
        Statement:
          - Action: logs:CreateLogGroup
            Effect: Allow
            Resource: "*"
          - Action:
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
              Ref: DatabaseSecret3B817195
          - Action:
              - ssm:DescribeParameters
              - ssm:GetParameter
              - ssm:GetParameterHistory
              - ssm:GetParameters
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":ssm:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :parameter/
                  - Ref: DatabaseConnectionString52D1E98E
        Version: "2012-10-17"
      PolicyName: UnicornUnicornStoreEcsTaskExecutionRoleDefaultPolicy3FC9EFEE
      Roles:
        - Ref: UnicornUnicornStoreEcsTaskExecutionRoleC2148AE8
    Type: AWS::IAM::Policy
  UnicornUnicornStoreEcsTaskRoleD7FBB789:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: "2012-10-17"
      Description: ECS task role for application runtime permissions
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/CloudWatchAgentServerPolicy
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/AWSXrayWriteOnlyAccess
      Path: /service-role/
      RoleName: unicornstore-ecs-task-role
    Type: AWS::IAM::Role
  UnicornUnicornStoreEcsTaskRoleDefaultPolicy477138EA:
    Properties:
      PolicyDocument:
        Statement:
          - Action: events:PutEvents
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - UnicornUnicornEventBusB728845C
                - Arn
        Version: "2012-10-17"
      PolicyName: UnicornUnicornStoreEcsTaskRoleDefaultPolicy477138EA
      Roles:
        - Ref: UnicornUnicornStoreEcsTaskRoleD7FBB789
    Type: AWS::IAM::Policy
  UnicornUnicornStoreEksPodRoleB15D12B7:
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
              - sts:TagSession
            Effect: Allow
            Principal:
              Service: pods.eks.amazonaws.com
        Version: "2012-10-17"
      Description: EKS Pod Identity role for Unicorn Store application
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/CloudWatchAgentServerPolicy
      RoleName: unicornstore-eks-pod-role
    Type: AWS::IAM::Role
  UnicornUnicornStoreEksPodRoleDefaultPolicy0D527B93:
    Properties:
      PolicyDocument:
        Statement:
          - Action: xray:PutTraceSegments
            Effect: Allow
            Resource: "*"
          - Action:
              - s3:GetObject
              - s3:ListBucket
              - s3:PutObject
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - WorkshopBucketFD5BC43F
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - WorkshopBucketFD5BC43F
                        - Arn
                    - /*
          - Action:
              - secretsmanager:DescribeSecret
              - secretsmanager:GetSecretValue
            Effect: Allow
            Resource:
              Ref: DatabaseSecret3B817195
          - Action:
              - ssm:DescribeParameters
              - ssm:GetParameter
              - ssm:GetParameterHistory
              - ssm:GetParameters
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":ssm:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :parameter/
                  - Ref: DatabaseConnectionString52D1E98E
          - Action: events:PutEvents
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - UnicornUnicornEventBusB728845C
                - Arn
        Version: "2012-10-17"
      PolicyName: UnicornUnicornStoreEksPodRoleDefaultPolicy0D527B93
      Roles:
        - Ref: UnicornUnicornStoreEksPodRoleB15D12B7
    Type: AWS::IAM::Policy
  VpcC3027511:
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      InstanceTenancy: default
      Tags:
        - Key: Name
          Value: workshop-vpc
    Type: AWS::EC2::VPC
  VpcIGW488B0FEB:
    Properties:
      Tags:
        - Key: Name
          Value: workshop-vpc
    Type: AWS::EC2::InternetGateway
  VpcPrivateSubnet1DefaultRouteF704DE9F:
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: VpcPublicSubnet1NATGateway8185E366
      RouteTableId:
        Ref: VpcPrivateSubnet1RouteTable901BAEEE
    Type: AWS::EC2::Route
  VpcPrivateSubnet1RouteTable901BAEEE:
    Properties:
      Tags:
        - Key: kubernetes.io/role/internal-elb
          Value: "1"
        - Key: Name
          Value: WorkshopStack/Vpc/Vpc/PrivateSubnet1
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::RouteTable
  VpcPrivateSubnet1RouteTableAssociation2BC202CB:
    Properties:
      RouteTableId:
        Ref: VpcPrivateSubnet1RouteTable901BAEEE
      SubnetId:
        Ref: VpcPrivateSubnet1Subnet67A4DBCB
    Type: AWS::EC2::SubnetRouteTableAssociation
  VpcPrivateSubnet1Subnet67A4DBCB:
    Properties:
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs: ""
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: aws-cdk:subnet-name
          Value: Private
        - Key: aws-cdk:subnet-type
          Value: Private
        - Key: kubernetes.io/role/internal-elb
          Value: "1"
        - Key: Name
          Value: WorkshopStack/Vpc/Vpc/PrivateSubnet1
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::Subnet
  VpcPrivateSubnet2DefaultRoute5FAC9901:
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId:
        Ref: VpcPublicSubnet1NATGateway8185E366
      RouteTableId:
        Ref: VpcPrivateSubnet2RouteTable1EA00C9D
    Type: AWS::EC2::Route
  VpcPrivateSubnet2RouteTable1EA00C9D:
    Properties:
      Tags:
        - Key: kubernetes.io/role/internal-elb
          Value: "1"
        - Key: Name
          Value: WorkshopStack/Vpc/Vpc/PrivateSubnet2
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::RouteTable
  VpcPrivateSubnet2RouteTableAssociationFA51927B:
    Properties:
      RouteTableId:
        Ref: VpcPrivateSubnet2RouteTable1EA00C9D
      SubnetId:
        Ref: VpcPrivateSubnet2SubnetC8EB537D
    Type: AWS::EC2::SubnetRouteTableAssociation
  VpcPrivateSubnet2SubnetC8EB537D:
    Properties:
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs: ""
      CidrBlock: 10.0.3.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: aws-cdk:subnet-name
          Value: Private
        - Key: aws-cdk:subnet-type
          Value: Private
        - Key: kubernetes.io/role/internal-elb
          Value: "1"
        - Key: Name
          Value: WorkshopStack/Vpc/Vpc/PrivateSubnet2
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::Subnet
  VpcPublicSubnet1DefaultRoute0F5C6C43:
    DependsOn:
      - VpcVPCGW42EC8516
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: VpcIGW488B0FEB
      RouteTableId:
        Ref: VpcPublicSubnet1RouteTable431DD755
    Type: AWS::EC2::Route
  VpcPublicSubnet1EIP2293BAA3:
    Properties:
      Domain: vpc
      Tags:
        - Key: kubernetes.io/role/elb
          Value: "1"
        - Key: Name
          Value: WorkshopStack/Vpc/Vpc/PublicSubnet1
    Type: AWS::EC2::EIP
  VpcPublicSubnet1NATGateway8185E366:
    DependsOn:
      - VpcPublicSubnet1DefaultRoute0F5C6C43
      - VpcPublicSubnet1RouteTableAssociationBBCB7AA1
    Properties:
      AllocationId:
        Fn::GetAtt:
          - VpcPublicSubnet1EIP2293BAA3
          - AllocationId
      SubnetId:
        Ref: VpcPublicSubnet1Subnet8E8DEDC0
      Tags:
        - Key: kubernetes.io/role/elb
          Value: "1"
        - Key: Name
          Value: WorkshopStack/Vpc/Vpc/PublicSubnet1
    Type: AWS::EC2::NatGateway
  VpcPublicSubnet1RouteTable431DD755:
    Properties:
      Tags:
        - Key: kubernetes.io/role/elb
          Value: "1"
        - Key: Name
          Value: WorkshopStack/Vpc/Vpc/PublicSubnet1
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::RouteTable
  VpcPublicSubnet1RouteTableAssociationBBCB7AA1:
    Properties:
      RouteTableId:
        Ref: VpcPublicSubnet1RouteTable431DD755
      SubnetId:
        Ref: VpcPublicSubnet1Subnet8E8DEDC0
    Type: AWS::EC2::SubnetRouteTableAssociation
  VpcPublicSubnet1Subnet8E8DEDC0:
    Properties:
      AvailabilityZone:
        Fn::Select:
          - 0
          - Fn::GetAZs: ""
      CidrBlock: 10.0.0.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: aws-cdk:subnet-name
          Value: Public
        - Key: aws-cdk:subnet-type
          Value: Public
        - Key: kubernetes.io/role/elb
          Value: "1"
        - Key: Name
          Value: WorkshopStack/Vpc/Vpc/PublicSubnet1
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::Subnet
  VpcPublicSubnet2DefaultRouteD629179A:
    DependsOn:
      - VpcVPCGW42EC8516
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: VpcIGW488B0FEB
      RouteTableId:
        Ref: VpcPublicSubnet2RouteTable77FB35FC
    Type: AWS::EC2::Route
  VpcPublicSubnet2RouteTable77FB35FC:
    Properties:
      Tags:
        - Key: kubernetes.io/role/elb
          Value: "1"
        - Key: Name
          Value: WorkshopStack/Vpc/Vpc/PublicSubnet2
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::RouteTable
  VpcPublicSubnet2RouteTableAssociation3AFE92E6:
    Properties:
      RouteTableId:
        Ref: VpcPublicSubnet2RouteTable77FB35FC
      SubnetId:
        Ref: VpcPublicSubnet2SubnetA811849C
    Type: AWS::EC2::SubnetRouteTableAssociation
  VpcPublicSubnet2SubnetA811849C:
    Properties:
      AvailabilityZone:
        Fn::Select:
          - 1
          - Fn::GetAZs: ""
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: aws-cdk:subnet-name
          Value: Public
        - Key: aws-cdk:subnet-type
          Value: Public
        - Key: kubernetes.io/role/elb
          Value: "1"
        - Key: Name
          Value: WorkshopStack/Vpc/Vpc/PublicSubnet2
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::Subnet
  VpcVPCGW42EC8516:
    Properties:
      InternetGatewayId:
        Ref: VpcIGW488B0FEB
      VpcId:
        Ref: VpcC3027511
    Type: AWS::EC2::VPCGatewayAttachment
  VpcVpcIdParameter240F384B:
    Properties:
      Description: Workshop VPC ID for cross-stack reference
      Name: workshop-vpc-id
      Type: String
      Value:
        Ref: VpcC3027511
    Type: AWS::SSM::Parameter
  WorkshopBucketBucketNameParameterCEE58012:
    Properties:
      Description: Workshop bucket name for thread dumps and profiling data
      Name: workshop-bucket-name
      Type: String
      Value:
        Ref: WorkshopBucketFD5BC43F
    Type: AWS::SSM::Parameter
  WorkshopBucketFD5BC43F:
    DeletionPolicy: Delete
    Properties:
      BucketName:
        Fn::Join:
          - ""
          - - workshop-bucket-
            - Ref: AWS::AccountId
            - "-"
            - Ref: AWS::Region
            - "-20260119085223"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    Type: AWS::S3::Bucket
    UpdateReplacePolicy: Delete
  WorkshopBucketPolicyA21947CB:
    Properties:
      Bucket:
        Ref: WorkshopBucketFD5BC43F
      PolicyDocument:
        Statement:
          - Action: s3:*
            Condition:
              Bool:
                aws:SecureTransport: "false"
            Effect: Deny
            Principal:
              AWS: "*"
            Resource:
              - Fn::GetAtt:
                  - WorkshopBucketFD5BC43F
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - WorkshopBucketFD5BC43F
                        - Arn
                    - /*
        Version: "2012-10-17"
    Type: AWS::S3::BucketPolicy
