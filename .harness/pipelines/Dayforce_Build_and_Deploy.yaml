pipeline:
  name: Dayforce Build and Deploy
  identifier: Dayforce_Build_and_Deploy
  projectIdentifier: soto_sandbox
  orgIdentifier: sandbox
  tags:
    owner: soto
  variables:
    - name: skip_build
      type: String
      description: Set to 'true' to skip the Build stage and only deploy
      required: false
      default: "false"
      value: <+input>.allowedValues(true,false)
  properties:
    ci:
      codebase:
        connectorRef: alexsotoharness
        repoName: java-on-aws
        build: <+input>
  stages:
    - stage:
        name: Build
        identifier: Build
        description: Build and test unicorn-store-jakarta with Test Intelligence
        type: CI
        when:
          pipelineStatus: Success
          condition: <+pipeline.variables.skip_build> != "true"
        spec:
          cloneCodebase: true
          caching:
            enabled: true
            key: maven-<+codebase.commitSha>
            paths:
              - /root/.m2/repository
          buildIntelligence:
            enabled: true
          platform:
            os: Linux
            arch: Amd64
          runtime:
            type: Cloud
            spec: {}
          execution:
            steps:
              - step:
                  type: RunTests
                  name: Run Tests with TI
                  identifier: Run_Tests_with_TI
                  spec:
                    connectorRef: account.harnessImage
                    image: maven:3.9.9-amazoncorretto-21
                    language: Java
                    buildTool: Maven
                    args: clean test -f apps/unicorn-store-jakarta/pom.xml
                    runOnlySelectedTests: true
                    preCommand: |
                      java -version
                      mvn -version
                    reports:
                      type: JUnit
                      spec:
                        paths:
                          - "**/*.xml"
              - step:
                  type: Run
                  name: Build WAR
                  identifier: Build_WAR
                  spec:
                    connectorRef: account.harnessImage
                    image: maven:3.9.9-amazoncorretto-21
                    shell: Sh
                    command: |
                      cd apps/unicorn-store-jakarta
                      mvn clean package -DskipTests
                      ls -la target/
              - step:
                  type: BuildAndPushDockerRegistry
                  name: Build and Push to DockerHub
                  identifier: Build_and_Push_to_DockerHub
                  spec:
                    connectorRef: dockerhubalexsotoharness
                    repo: alexsotoharness/unicorn-store-jakarta
                    tags:
                      - <+pipeline.sequenceId>
                      - latest
                    caching: true
                    dockerfile: apps/unicorn-store-jakarta/wildfly/Dockerfile
                    context: apps/unicorn-store-jakarta
    - stage:
        name: Deploy to OrbStack
        identifier: Deploy_to_OrbStack
        description: Deploy unicorn-store-jakarta to local OrbStack Kubernetes cluster
        type: Deployment
        spec:
          deploymentType: Kubernetes
          service:
            serviceRef: unicorn_store_jakarta
            serviceInputs:
              serviceDefinition:
                type: Kubernetes
                spec:
                  artifacts:
                    primary:
                      primaryArtifactRef: dockerhub_image
                      sources:
                        - identifier: dockerhub_image
                          type: DockerRegistry
                          spec:
                            tag: <+input>.default(latest)
          environment:
            environmentRef: harnessdevenv
            deployToAll: false
            infrastructureDefinitions:
              - identifier: orbstack_local
          execution:
            steps:
              - step:
                  type: K8sRollingDeploy
                  name: Rolling Deployment
                  identifier: Rolling_Deployment
                  spec:
                    skipDryRun: false
                    pruningEnabled: false
                  timeout: 10m
            rollbackSteps:
              - step:
                  type: K8sRollingRollback
                  name: Rollback
                  identifier: Rollback
                  spec:
                    pruningEnabled: false
                  timeout: 10m
        tags: {}
        failureStrategies:
          - onFailure:
              errors:
                - AllErrors
              action:
                type: StageRollback
